{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Add Product - LivestockHub{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold gradient-text mb-3">Add New Product</h1>
                <p class="text-muted lead">List your livestock products with the right category</p>
            </div>

            <!-- Product Form Card -->
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0 py-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary rounded-circle p-3 me-3">
                            <i class="fas fa-plus text-white fs-4"></i>
                        </div>
                        <div>
                            <h4 class="mb-1">Product Information</h4>
                            <p class="text-muted mb-0">Fill in the details about your livestock</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="product-form">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Product Name *</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Category *</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Livestock Type *</label>
                                {{ form.livestock_type }}
                                {% if form.livestock_type.errors %}
                                <div class="text-danger small mt-1">{{ form.livestock_type.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Animal Type *</label>
                                {{ form.animal_type }}
                                {% if form.animal_type.errors %}
                                <div class="text-danger small mt-1">{{ form.animal_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Price (RWF) *</label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                <div class="text-danger small mt-1">{{ form.price.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-semibold">Stock Quantity *</label>
                                {{ form.stock_quantity }}
                                {% if form.stock_quantity.errors %}
                                <div class="text-danger small mt-1">{{ form.stock_quantity.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Description *</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Image Upload - First Image -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Primary Product Image *</label>
                            <div class="border-2 border-dashed rounded-3 p-4 text-center upload-area" data-target="id_image">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-choose-file" data-target="id_image">
                                        <i class="fas fa-folder-open me-2"></i>Choose File
                                    </button>
                                    {{ form.image }}
                                </div>
                                <div class="mt-2">
                                    <i class="fas fa-cloud-upload-alt text-muted fs-1 mb-2"></i>
                                    <p class="text-muted mb-1">Or drag and drop your image here</p>
                                    <p class="text-muted small">PNG, JPG, JPEG (Max. 5MB)</p>
                                </div>
                                <div class="file-name mt-2" id="file-name-id_image"></div>
                            </div>
                            {% if form.image.errors %}
                            <div class="text-danger small mt-1">{{ form.image.errors }}</div>
                            {% endif %}
                            <div id="image-preview-1" class="mt-2 text-center"></div>
                        </div>

                        <!-- Image Upload - Second Image -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Additional Product Image</label>
                            <div class="border-2 border-dashed rounded-3 p-4 text-center upload-area" data-target="id_image2">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-choose-file" data-target="id_image2">
                                        <i class="fas fa-folder-open me-2"></i>Choose File
                                    </button>
                                    {{ form.image2 }}
                                </div>
                                <div class="mt-2">
                                    <i class="fas fa-cloud-upload-alt text-muted fs-1 mb-2"></i>
                                    <p class="text-muted mb-1">Or drag and drop your image here</p>
                                    <p class="text-muted small">PNG, JPG, JPEG (Max. 5MB)</p>
                                </div>
                                <div class="file-name mt-2" id="file-name-id_image2"></div>
                            </div>
                            {% if form.image2.errors %}
                            <div class="text-danger small mt-1">{{ form.image2.errors }}</div>
                            {% endif %}
                            <div id="image-preview-2" class="mt-2 text-center"></div>
                        </div>

                        <!-- Image Upload - Third Image -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Additional Product Image</label>
                            <div class="border-2 border-dashed rounded-3 p-4 text-center upload-area" data-target="id_image3">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-choose-file" data-target="id_image3">
                                        <i class="fas fa-folder-open me-2"></i>Choose File
                                    </button>
                                    {{ form.image3 }}
                                </div>
                                <div class="mt-2">
                                    <i class="fas fa-cloud-upload-alt text-muted fs-1 mb-2"></i>
                                    <p class="text-muted mb-1">Or drag and drop your image here</p>
                                    <p class="text-muted small">PNG, JPG, JPEG (Max. 5MB)</p>
                                </div>
                                <div class="file-name mt-2" id="file-name-id_image3"></div>
                            </div>
                            {% if form.image3.errors %}
                            <div class="text-danger small mt-1">{{ form.image3.errors }}</div>
                            {% endif %}
                            <div id="image-preview-3" class="mt-2 text-center"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 justify-content-end pt-4 border-top">
                            <a href="{% url 'marketplace:seller_products' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-plus me-2"></i>Add Product
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Category Management Link -->
            <div class="text-center mt-4">
                <a href="{% url 'marketplace:manage_categories' %}" class="btn btn-outline-primary">
                    <i class="fas fa-cog me-2"></i>Manage Categories
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .border-dashed {
        border-style: dashed !important;
    }
    
    /* File input styling */
    .btn-choose-file {
        position: relative;
        overflow: hidden;
    }
    
    .file-input-hidden {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .file-name {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .file-name.has-file {
        color: var(--primary);
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        margin: 10px auto;
        border: 2px solid #e2e8f0;
    }
    
    .drag-over {
        border-color: var(--primary) !important;
        background-color: rgba(16, 185, 129, 0.05) !important;
    }
    
    .upload-area {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: var(--primary);
        background-color: rgba(16, 185, 129, 0.02);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const livestockTypeSelect = document.getElementById('id_livestock_type');
    const animalTypeSelect = document.getElementById('id_animal_type');

    // Function to update animal type choices based on livestock type
    function updateAnimalTypeChoices(livestockType) {
        if (!livestockType) {
            animalTypeSelect.innerHTML = '<option value="">---------</option>';
            return;
        }

        // Send AJAX request to get animal types
        fetch(`/marketplace/get-animal-types/?livestock_type=${livestockType}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Clear existing options
                animalTypeSelect.innerHTML = '<option value="">---------</option>';
                
                // Add new options based on the livestock type
                if (data.animal_types) {
                    data.animal_types.forEach(function(animalType) {
                        const option = document.createElement('option');
                        option.value = animalType[0];
                        option.textContent = animalType[1];
                        animalTypeSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching animal types:', error);
                animalTypeSelect.innerHTML = '<option value="">---------</option>';
                
                // Fallback: manually set options based on livestock type
                const fallbackOptions = getFallbackAnimalTypes(livestockType);
                animalTypeSelect.innerHTML = '<option value="">---------</option>';
                fallbackOptions.forEach(function(animalType) {
                    const option = document.createElement('option');
                    option.value = animalType[0];
                    option.textContent = animalType[1];
                    animalTypeSelect.appendChild(option);
                });
            });
    }

    // Fallback function in case AJAX fails
    function getFallbackAnimalTypes(livestockType) {
        const typeMapping = {
            'cattle': [
                ['cow', 'Cow'],
                ['bull', 'Bull'],
                ['calf', 'Calf'],
                ['heifer', 'Heifer'],
                ['ox', 'Ox']
            ],
            'goats': [
                ['meat', 'Meat Goat'],
                ['milk', 'Dairy Goat'],
                ['kid', 'Kid'],
                ['buck', 'Buck'],
                ['doe', 'Doe']
            ],
            'sheep': [
                ['lamb', 'Lamb'],
                ['mutton', 'Mutton'],
                ['ram', 'Ram'],
                ['ewe', 'Ewe'],
                ['lamb_meat', 'Lamb Meat']
            ],
            'poultry': [
                ['meat', 'Meat Chicken'],
                ['eggs', 'Layer Chicken'],
                ['broiler', 'Broiler'],
                ['rooster', 'Rooster'],
                ['hen', 'Hen'],
                ['chick', 'Chick']
            ],
            'pigs': [
                ['pork', 'Pork'],
                ['bacon', 'Bacon'],
                ['sow', 'Sow'],
                ['boar', 'Boar'],
                ['piglet', 'Piglet']
            ],
            'rabbits': [
                ['meat', 'Rabbit Meat'],
                ['doe_rabbit', 'Doe Rabbit'],
                ['buck_rabbit', 'Buck Rabbit'],
                ['fryer', 'Fryer']
            ],
            'fish': [
                ['tilapia', 'Tilapia'],
                ['catfish', 'Catfish'],
                ['trout', 'Trout'],
                ['salmon', 'Salmon'],
                ['freshwater', 'Freshwater Fish'],
                ['saltwater', 'Saltwater Fish']
            ],
            'others': [
                ['bees', 'Bees/Honey'],
                ['snails', 'Snails'],
                ['guinea_fowl', 'Guinea Fowl'],
                ['turkey', 'Turkey'],
                ['duck', 'Duck']
            ]
        };
        
        return typeMapping[livestockType] || [];
    }

    // Handle livestock type change
    if (livestockTypeSelect) {
        livestockTypeSelect.addEventListener('change', function() {
            updateAnimalTypeChoices(this.value);
        });
    }

    // Image upload functionality
    function setupImageUpload(fileInputId, fileNameId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        const fileNameDisplay = document.getElementById(fileNameId);
        const preview = document.getElementById(previewId);
        const chooseBtn = document.querySelector(`.btn-choose-file[data-target="${fileInputId}"]`);
        const uploadArea = document.querySelector(`.upload-area[data-target="${fileInputId}"]`);

        // Check if all required elements exist
        if (!fileInput || !chooseBtn || !uploadArea) {
            console.warn(`Missing elements for file upload: ${fileInputId}`);
            return;
        }

        // Style file input to be hidden but accessible
        fileInput.style.display = 'none';

        // Click choose button triggers file input
        chooseBtn.addEventListener('click', function() {
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file type
                if (!file.type.match('image.*')) {
                    alert('Please select an image file (PNG, JPG, JPEG)');
                    fileInput.value = '';
                    if (fileNameDisplay) {
                        fileNameDisplay.textContent = '';
                        fileNameDisplay.classList.remove('has-file');
                    }
                    return;
                }

                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    fileInput.value = '';
                    if (fileNameDisplay) {
                        fileNameDisplay.textContent = '';
                        fileNameDisplay.classList.remove('has-file');
                    }
                    return;
                }

                // Update file name display
                if (fileNameDisplay) {
                    fileNameDisplay.textContent = `Selected: ${file.name}`;
                    fileNameDisplay.classList.add('has-file');
                }

                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (preview) {
                        preview.innerHTML = `
                            <div class="d-flex align-items-center justify-content-center">
                                <img src="${e.target.result}" class="image-preview" alt="Preview">
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearImage('${fileInputId}', '${fileNameId}', '${previewId}')">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    // Clear image function
    window.clearImage = function(fileInputId, fileNameId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        const fileNameDisplay = document.getElementById(fileNameId);
        const preview = document.getElementById(previewId);
        
        if (fileInput) {
            fileInput.value = '';
        }
        if (fileNameDisplay) {
            fileNameDisplay.textContent = '';
            fileNameDisplay.classList.remove('has-file');
        }
        if (preview) {
            preview.innerHTML = '';
        }
    };

    // Initialize all image upload areas
    const uploadConfigs = [
        { fileInputId: 'id_image', fileNameId: 'file-name-id_image', previewId: 'image-preview-1' },
        { fileInputId: 'id_image2', fileNameId: 'file-name-id_image2', previewId: 'image-preview-2' },
        { fileInputId: 'id_image3', fileNameId: 'file-name-id_image3', previewId: 'image-preview-3' }
    ];

    uploadConfigs.forEach(config => {
        setupImageUpload(config.fileInputId, config.fileNameId, config.previewId);
    });

    // Form validation
    const form = document.getElementById('product-form');
    if (form) {
        form.addEventListener('submit', function(event) {
            const livestockType = livestockTypeSelect ? livestockTypeSelect.value : '';
            const animalType = animalTypeSelect ? animalTypeSelect.value : '';

            // Validate animal type selection
            if (livestockType && !animalType) {
                event.preventDefault();
                alert('Please select an animal type for the chosen livestock type.');
                return;
            }
        });
    }

    // Initialize animal type choices if livestock type is already selected
    if (livestockTypeSelect && livestockTypeSelect.value) {
        updateAnimalTypeChoices(livestockTypeSelect.value);
    }
});
</script>
{% endblock %}