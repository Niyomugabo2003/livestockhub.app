<!-- templates/marketplace/seller_reports.html -->
{% extends 'base.html' %}
{% load static %}
{% load report_filters %}

{% block title %}Sales Analytics - LivestockHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">ðŸ“Š Sales Analytics</h1>
            <p class="text-muted">Real-time data from your delivered products</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                <i class="fas fa-plus me-2"></i>New Report
            </button>
            <a href="?refresh=true" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Revenue (30 days)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">RWF {{ total_revenue|floatformat:0|default:"0" }}</div>
                            <div class="text-success text-xs">
                                <i class="fas fa-calendar me-1"></i>Last 30 days
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Orders (30 days)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_orders|default:"0" }}</div>
                            <div class="text-success text-xs">
                                <i class="fas fa-shopping-cart me-1"></i>{{ products_sold|default:"0" }} products sold
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Products Sold
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ products_sold|default:"0" }}</div>
                            <div class="text-info text-xs">
                                <i class="fas fa-box me-1"></i>Across all orders
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Avg. Order Value
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">RWF {{ avg_order_value|floatformat:0|default:"0" }}</div>
                            <div class="text-warning text-xs">
                                <i class="fas fa-chart-line me-1"></i>Per order average
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics -->
    <div class="row">
        <!-- Revenue Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue Overview (Last 6 Months)</h6>
                    <span class="badge bg-primary">Live Data</span>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="revenueChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Selling Products</h6>
                </div>
                <div class="card-body">
                    {% if top_products %}
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="productsChart" height="200"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        {% for product in top_products %}
                        <span class="me-2 d-block">
                            <i class="fas fa-circle text-{{ forloop.counter0|get_chart_color }} me-1"></i> 
                            {{ product.product__name|truncatechars:20|default:"Unknown Product" }} ({{ product.total_sold|default:"0" }} sold)
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No sales data available yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Orders</h6>
                    <span class="badge bg-primary">Last 30 days</span>
                </div>
                <div class="card-body">
                    {% if recent_orders %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Items</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td>
                                        <strong>#{{ order.order_number|default:"N/A" }}</strong>
                                    </td>
                                    <td>{{ order.created_at|date:"M d, Y"|default:"Unknown" }}</td>
                                    <td>{{ order.customer.get_full_name|default:order.customer.username|default:"Unknown Customer" }}</td>
                                    <td class="fw-bold text-success">RWF {{ order.total_amount|floatformat:0|default:"0" }}</td>
                                    <td>
                                        <span class="badge bg-{{ order.status|get_status_badge }}">
                                            {{ order.get_status_display|default:"Unknown" }}
                                        </span>
                                    </td>
                                    <td>
                                        {% for item in order.items.all %}
                                            {% if item.product and item.product.seller == request.user %}
                                            <span class="badge bg-light text-dark mb-1">
                                                {{ item.product.name|default:"Unknown Product" }} (x{{ item.quantity|default:"0" }})
                                            </span>
                                            {% endif %}
                                        {% empty %}
                                            <span class="text-muted">No items</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5>No recent orders</h5>
                        <p class="text-muted">Your sales data will appear here when you receive orders</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Generate New Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" name="report_type" required>
                                <option value="">Select report type...</option>
                                <option value="sales">Sales Report</option>
                                <option value="products">Products Report</option>
                                <option value="revenue">Revenue Report</option>
                                <option value="inventory">Inventory Report</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Time Period</label>
                            <select class="form-select" name="period" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-rocket me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    border-radius: 0.5rem;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.border-left-primary { border-left: 0.25rem solid #4e73df !important; }
.border-left-success { border-left: 0.25rem solid #1cc88a !important; }
.border-left-info { border-left: 0.25rem solid #36b9cc !important; }
.border-left-warning { border-left: 0.25rem solid #f6c23e !important; }

.chart-area {
    position: relative;
    height: 300px;
    width: 100%;
}

.chart-pie {
    position: relative;
    height: 200px;
    width: 100%;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.badge {
    font-size: 0.75em;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        // Show simple message instead of chart to avoid errors
        revenueCtx.parentElement.innerHTML = '<div class="text-center py-4"><p class="text-muted">Revenue chart will be available soon</p></div>';
    }

    // Products Chart
    const productsCtx = document.getElementById('productsChart');
    if (productsCtx) {
        // Show simple message instead of chart to avoid errors
        productsCtx.parentElement.innerHTML = '<div class="text-center py-4"><p class="text-muted">Products chart will be available soon</p></div>';
    }
});

function generateReport() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    
    // Simulate report generation
    const modalElement = document.getElementById('generateReportModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    
    // Show success message
    showNotification('Report generation started! You will be notified when ready.', 'success');
}

function showNotification(message, type) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(alert);
    
    setTimeout(function() {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}